<!DOCTYPE html>
<html lang="en">
  <!-- prettier-ignore -->
  <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="robots" content="noindex,nofollow" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
        <title>Gap Report Generator</title>
        <style>[type=text],input[type=text]{letter-spacing:1px;color:#333}#container,h2,h3{text-align:center}.animate-bottom,.icon-shadow,.omni,.spec,h2{position:relative}#file-name,#omni-title,[type=text]{color:#333}#omni-title,.omni{display:inline-block}#omni-title,h3,i{margin-bottom:20px}#download-counter,#effort-counter,#omni-title,.report,h2{font-weight:700}body,input{font-family:'Open Sans',sans-serif}h2{font-size:20px}.omni>span,h3{font-weight:400}h3{font-size:14px}input[type=text]{font-size:16px;width:100%;-webkit-box-sizing:border-box;box-sizing:border-box}:focus{outline:0}.spec{width:30%;margin:15px 1%}[type=text]{width:100%;-webkit-box-sizing:border-box;box-sizing:border-box}.file-div,i{color:#999}.input-text{border:1px solid #ccc;padding:7px 14px 9px;-webkit-transition:.4s;-o-transition:.4s;transition:.4s;background:0 0}.input-text~.focus-border:after,.input-text~.focus-border:before{content:'';position:absolute;top:0;left:50%;width:0;height:2px;background-color:#000d42;-webkit-transition:.4s;-o-transition:.4s;transition:.4s}.input-text~.focus-border:after{top:auto;bottom:0}.input-text~.focus-border i:after,.input-text~.focus-border i:before{content:'';position:absolute;top:50%;left:0;width:2px;height:0;background-color:#000d42;-webkit-transition:.6s;-o-transition:.6s;transition:.6s}.input-text~.focus-border i:after{left:auto;right:0}.input-text:focus~.focus-border:after,.input-text:focus~.focus-border:before{left:0;width:100%;-webkit-transition:.4s;-o-transition:.4s;transition:.4s}.input-text:focus~.focus-border i:after,.input-text:focus~.focus-border i:before{top:0;height:100%;-webkit-transition:.6s;-o-transition:.6s;transition:.6s}#file{position:absolute}#container,#file{width:100%;height:100%;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}@-webkit-keyframes spin{0%{-webkit-transform:rotate(0)}100%{-webkit-transform:rotate(360deg)}}@keyframes spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}.animate-bottom{-webkit-animation-name:animateBottom;-webkit-animation-duration:1s;animation-name:animateBottom;animation-duration:1s}@-webkit-keyframes animateBottom{from{bottom:-300px;opacity:0}to{bottom:0;opacity:1}}@keyframes animateBottom{from{bottom:-300px;opacity:0}to{bottom:0;opacity:1}}p{margin:0;padding:0}.report{margin:.5em}#omni-div{margin-top:30px}#click-counter{font-size:12px}.omni{border:2px dashed #000d42;border-radius:10px;padding:10px 40px}#file{cursor:pointer;top:0;left:0;opacity:0;display:block;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;font-size:0;text-indent:-100px}.omni>span{color:#ccc;font-size:16px}#container .inputs{width:90%;margin:0 auto}i{width:100%}.icon-shadow{display:block;width:95px;height:7px;border-radius:100%;background-color:#eee;top:-17px;margin-left:auto;margin-right:auto}#omni-div,.inputs{display:block}.campaign-type{width:130px;padding:14px;margin-bottom:20px;-webkit-backface-visibility:hidden;backface-visibility:hidden;border-style:solid;border-width:2px;-webkit-box-sizing:border-box;box-sizing:border-box;color:#212121;cursor:pointer;display:inline-block;text-align:center;text-decoration:none;-webkit-transform:translateZ(0) scale(1);transform:translateZ(0) scale(1);-webkit-transition:-webkit-transform .2s;transition:transform .2s;-o-transition:transform .2s;transition:transform .2s,-webkit-transform .2s;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-user-select:none;-ms-touch-action:manipulation;touch-action:manipulation}.campaign-type:not(:disabled):hover{background:#f18989;-webkit-transform:scale(1.05);-ms-transform:scale(1.05);transform:scale(1.05)}.campaign-type:not(:disabled):hover:active{-webkit-transform:scale(1.05) translateY(.125rem);-ms-transform:scale(1.05) translateY(.125rem);transform:scale(1.05) translateY(.125rem)}.campaign-type:focus,.campaign-type:focus:not(:focus-visible){outline:transparent solid 0}.campaign-type:focus:before{content:"";left:calc(-1*.375rem);pointer-events:none;position:absolute;top:calc(-1*.375rem);-webkit-transition:border-radius;-o-transition:border-radius;transition:border-radius;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.campaign-type:focus:not(:focus-visible):before{border-width:0}.campaign-type:not(:disabled):active{-webkit-transform:translateY(.125rem);-ms-transform:translateY(.125rem);transform:translateY(.125rem)}.bulk{background:#f18989}.input-set{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}</style> <script lang="javascript" src="https://cdn.sheetjs.com/xlsx-0.19.2/package/dist/xlsx.mini.min.js" ></script> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w==" crossorigin="anonymous" referrerpolicy="no-referrer"/> <link rel="preconnect" href="https://fonts.googleapis.com"/> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/> <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet"/>
    </head>
  <body>
    <!-- prettier-ignore -->
    <div id="container" class="animate-bottom"> <h1>Gap Report Generator</h1> <h2> <span style="color: red">[ </span>George Antoniou - EMEA SDE team<span style="color: red">]</span> </h2>
      <!-- <h3>This app has generated <span id="download-counter"></span> reports and saved more than <span id="effort-counter"></span> hours of effort! </h3>  -->
      <div class="inputs"> <div class="campaign-select"> <a class="campaign-type bulk" href="./gaprepgen.html">Bulk</a> <a class="campaign-type triggered" href="./gaprepgentrig.html" >Triggered</a > </div></div><div class="file-div"> <div id="omni-div"> <label class="report omni" for="file" ><span id="omni-title">Omniture report</span ><i class="fas fa-file-upload fa-7x"></i ><span class="icon-shadow"></span ><span >Click to browse <span class="drag">or drop file here</span></span > <input name="file" id="file" class="file" type="file" accept=".csv" onchange="readFile(this.files);"/> </label> </div><p class="file-name" id="file-name">No file selected!</p></div></div>
    <script>
      function createInputDiv() {
        const fragment = document.createDocumentFragment();

        for (let i = 1; i <= 9; i++) {
          const container = document.createElement('div');
          container.classList.add(`input-set`);
          container.id = `input-set${i}`;

          const inputDiv1 = document.createElement('div');
          inputDiv1.classList.add('spec', 'input-div');

          const inputName1 = document.createElement('input');
          inputName1.classList.add('input-text');
          inputName1.type = 'text';
          inputName1.id = `campaign-name${i}`;
          inputName1.name = `campaign-name${i}`;
          inputName1.placeholder = `Campaign Name #${i}`;

          const span1 = document.createElement('span');
          span1.classList.add('focus-border');

          const i1 = document.createElement('i');
          span1.appendChild(i1);

          inputDiv1.appendChild(inputName1);
          inputDiv1.appendChild(span1);

          const inputDiv2 = document.createElement('div');
          inputDiv2.classList.add('spec', 'input-div');

          const inputLink = document.createElement('input');
          inputLink.classList.add('input-text');
          inputLink.type = 'text';
          inputLink.id = `portal-link${i}`;
          inputLink.name = `portal-link${i}`;
          inputLink.placeholder = `Portal Link #${i}`;

          const span2 = document.createElement('span');
          span2.classList.add('focus-border');

          const i2 = document.createElement('i');
          span2.appendChild(i2);

          inputDiv2.appendChild(inputLink);
          inputDiv2.appendChild(span2);

          const inputDiv3 = document.createElement('div');
          inputDiv3.classList.add('spec', 'input-div');

          const inputIds = document.createElement('input');
          inputIds.classList.add('input-text');
          inputIds.type = 'text';
          inputIds.id = `geno-ids${i}`;
          inputIds.name = `geno-ids${i}`;
          inputIds.placeholder = `Geno IDs #${i}`;

          const span3 = document.createElement('span');
          span3.classList.add('focus-border');

          const i3 = document.createElement('i');
          span3.appendChild(i3);

          inputDiv3.appendChild(inputIds);
          inputDiv3.appendChild(span3);

          container.appendChild(inputDiv1);
          container.appendChild(inputDiv2);
          container.appendChild(inputDiv3);

          fragment.appendChild(container);
        }

        document.querySelector('.inputs').appendChild(fragment);
      }

      createInputDiv();

      const file = document.getElementById('file'),
        finalResults = [],
        inputs = [];
      let rawData = [];

      file.addEventListener('change', (e) => {
        const [file] = e.target.files,
          { name: fileName, size } = file,
          fileSize = (size / 1000).toFixed(2),
          fileNameAndSize = `${fileName} - ${addCommas(fileSize)} KB`;
        document.querySelector('.file-name').textContent = fileNameAndSize;
      });

      function readFile(file) {
        try {
          validateInputs();
        } catch (error) {
          alert(error.message);
          location.reload();
        }

        const reader = new FileReader();

        reader.onload = function (e) {
          const fileData = e.target.result,
            wb = XLSX.read(fileData, {
              type: 'binary',
            });
          const xlRowObj = XLSX.utils.sheet_to_row_object_array(
            wb.Sheets[wb.SheetNames[0]]
          );

          rawData = xlRowObj.map((a) => {
            return { ...a };
          });
          createReport(
            rawData.map((a) => {
              return { ...a };
            })
          );
        };
        setTimeout(() => {
          try {
            downloadXL(generateFileName());
          } catch (error) {
            alert(error.message);
            location.reload();
          }
        }, 1000);

        reader.readAsBinaryString(file[0]);
      }

      // function countClicks(endpoint) {
      //   const xhr = new XMLHttpRequest();
      //   xhr.open(
      //     'GET',
      //     `https://api.countapi.xyz/${endpoint}/gantoniou/gaprepgen`
      //   );
      //   xhr.responseType = 'json';
      //   xhr.onload = function () {
      //     if (endpoint === 'info') {
      //       document.getElementById('download-counter').textContent =
      //         this.response.value;
      //       document.getElementById('effort-counter').textContent =
      //         roundToHours(this.response.value * 34);
      //     }
      //   };
      //   xhr.send();
      // }

      // countClicks('info');

      function addCommas(num) {
        return num.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ',');
      }

      function roundToHours(mins) {
        const hours = Math.floor(mins / 60);
        return hours;
      }

      function validateInputs() {
        const inputSets = [],
          allInputs = document.getElementsByClassName('input-text');
        let inputSetsNum = allInputs.length / 3;

        for (let i = 0; i < inputSetsNum; i++) {
          inputSets.push(
            document
              .getElementById('input-set' + (i + 1))
              .getElementsByTagName('input')
          );
        }

        for (input of allInputs) {
          if (input.value.trim().length) {
            inputs.push(input.value);
          }
        }

        inputSetsNum = inputs.length / 3;

        for (let i = 0; i < inputSetsNum; i++) {
          const [campaignName, portalLink, genoIds] = inputSets[i];
          if (!campaignName.value || !portalLink.value || !genoIds.value) {
            throw new Error('Missing campaign data!');
          } else if (
            !portalLink.value.startsWith('https://portal.persado.com/')
          ) {
            throw new Error('Invalid Portal link!');
          }
        }
      }

      function updateNetDemand(data) {
        data.forEach((d) => {
          d['Net Demand'] =
            d['Revenue (Gross Merchandise)'] -
            (d['Line + Brand Discount (e43) (event43)'] +
              d['Order Level Discount [non-PLCC] (e44) (event44)'] +
              d['PLCC Discount (e48) (event48)'] +
              d['Pay with Points Discount (e329) (event329)']);
        });
      }

      function updateAvgs(results) {
        const avgs = results.reduce((res, current) => {
          return res.concat(Array(3).fill(current));
        }, []);

        for (let i = 0; i < finalResults.length; i++) {
          finalResults[i]['Average Lift Opens'] =
            (
              ((avgs[i][1][1] + avgs[i][2][1]) /
                (avgs[i][1][0] + avgs[i][2][0]) /
                (avgs[i][0][1] / avgs[i][0][0]) -
                1) *
              100
            ).toFixed(2) + '%';
          finalResults[i]['Average Lift Clicks'] =
            (
              ((avgs[i][1][2] + avgs[i][2][2]) /
                (avgs[i][1][0] + avgs[i][2][0]) /
                (avgs[i][0][2] / avgs[i][0][0]) -
                1) *
              100
            ).toFixed(2) + '%';
          finalResults[i]['Average Lift Conversions'] =
            (
              ((avgs[i][1][3] + avgs[i][2][3]) /
                (avgs[i][1][0] + avgs[i][2][0]) /
                (avgs[i][0][3] / avgs[i][0][0]) -
                1) *
              100
            ).toFixed(2) + '%';
          const incRevenue =
            ((avgs[i][1][4] + avgs[i][2][4]) / (avgs[i][1][0] + avgs[i][2][0]) -
              avgs[i][0][4] / avgs[i][0][0]) *
            (avgs[i][1][0] + avgs[i][2][0]);
          finalResults[i]['Incremental Revenue'] =
            incRevenue >= 0
              ? '$' + addCommas(incRevenue.toFixed(2))
              : '-$' + addCommas(Math.abs(incRevenue).toFixed(2));
        }
      }

      function generateFileName() {
        const fileInput = document.getElementById('file'),
          fName = fileInput.files[0].name,
          fileSplit = fName.split('_'),
          fileBrand = fileSplit[0],
          fileDate = fileSplit[fileSplit.length - 1].split('.')[0];
        fileName = `${fileBrand}_${fileDate}.xlsx`;
        return fileName;
      }

      function createReport(rawData) {
        const data = rawData,
          inputObj = [],
          results = [],
          metrics = ['Delivered', 'Opened', 'Clicked', 'Orders', 'Net Demand'],
          variants = ['C', 'T1', 'T2'];

        for (let z = 0; z < inputs.length / 3; z++) {
          inputObj.push({
            'Campaign Name': inputs[z * 3],
            'Portal Link': inputs[z * 3 + 1],
            'Geno Ids': inputs[z * 3 + 2]
              .match(/(?:\d+\.)?\d+/g)
              .filter(Number),
          });
          const input = inputObj[z];
          if (input['Geno Ids'] && input['Geno Ids'].length > 1) {
            let maxIndex = 0;
            for (let i = 1; i < input['Geno Ids'].length; i++) {
              if (input['Geno Ids'][i] > input['Geno Ids'][maxIndex]) {
                maxIndex = i;
              }
            }

            const maxVal = input['Geno Ids'][maxIndex];
            input['Geno Ids'].splice(maxIndex, 1);
            input['Geno Ids'].unshift(maxVal);
          }

          updateNetDemand(data);

          results.push(Array.from({ length: 3 }, () => Array(5).fill(0)));

          const result = results[z];

          for (let i = 0; i < variants.length; i++) {
            const genoId = input['Geno Ids'][i];
            const validEmails = ['PERSXC1X', 'PERSXT1X', 'PERSXT2X'];

            data.forEach((d) => {
              const emailVersion = d['Email version (v11) (evar11)'];
              for (let k = 0; k < metrics.length; k++) {
                if (
                  emailVersion.includes(genoId) &&
                  validEmails.some((email) => emailVersion.includes(email))
                ) {
                  for (let key in d) {
                    if (key.startsWith(metrics[k])) {
                      result[i][k] += d[key];
                      break;
                    }
                  }
                }
                result[i][k] = parseFloat(result[i][k].toFixed(2));
              }
            });

            finalResults.push({
              'Experiment Name & Link': input['Campaign Name'],
              Variant: variants[i],
              Delivered: result[i][0],
              Opened: result[i][1],
              Clicked: result[i][2],
              Orders: result[i][3],
              'Net Demand': result[i][4],
              '': '',
              'Open Rate':
                ((result[i][1] / result[i][0]) * 100).toFixed(2) + '%',
              'Average Lift Opens': 0,
              'Click Rate':
                ((result[i][2] / result[i][0]) * 100).toFixed(2) + '%',
              'Average Lift Clicks': 0,
              'Conversion Rate':
                ((result[i][3] / result[i][0]) * 100).toFixed(2) + '%',
              'Average Lift Conversions': 0,
              'Incremental Revenue': 0,
              'Geno ID': input['Geno Ids'][i],
            });
          }
        }
        updateAvgs(results);
      }

      function downloadXL(fileName) {
        if (inputs.length === 0) {
          throw new Error('Missing campaign data!');
        } else {
          fileName = fileName || 'GapFinalReport.xlsx';
          const ws1 = XLSX.utils.json_to_sheet(finalResults),
            ws2 = XLSX.utils.json_to_sheet(rawData),
            wb = XLSX.utils.book_new();

          XLSX.utils.book_append_sheet(wb, ws1, 'Results');
          XLSX.utils.book_append_sheet(wb, ws2, 'Raw Data');
          const merge = [];
          const fillArray = [9, 9, 9, 9, 9];
          const cArray = [0, 9, 11, 13, 14];

          for (let i = 0; i < fillArray.length; i++) {
            const c = cArray[i];
            for (let j = 0; j < fillArray[i]; j++) {
              merge.push({
                s: { r: 1 + 3 * j, c: c },
                e: { r: 3 + 3 * j, c: c },
              });
            }
          }

          ws1['!merges'] = merge;

          for (let i = 1; i < inputs.length; i += 3) {
            ws1['A' + (i + 1)].l = {
              Target: inputs[i],
            };
          }

          const date = new Date();
          const currentDate = date.toLocaleString('default', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
          });

          XLSX.utils.sheet_add_aoa(ws1, [['Results Pulled: ' + currentDate]], {
            origin: 'A30',
          });

          XLSX.writeFile(wb, fileName);

          //countClicks('hit');
          alert('Report created successfully!');

          location.reload();
        }
      }
    </script>
  </body>
</html>
